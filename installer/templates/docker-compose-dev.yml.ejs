version: '3'

services:
  <%= APP_NAME %>-api:
    container_name: <%= APP_NAME %>-api
    restart: unless-stopped
    ports:
      - "1337:1337"
    volumes:
      - ./app:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-mongodb:27017", "--", "npm", "run" ,"dev"]
    build:
      context: .
      dockerfile: Dockerfile-api
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_API}
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-redis-sockets
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker-checks:
    container_name: <%= APP_NAME %>-worker-checks
    restart: unless-stopped
    volumes:
      - ./api:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-mongodb:27017", "--", "npm", "run" ,"dev:worker"]
    build:
      context: .
      dockerfile: Dockerfile-worker
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_WORKER_CHECKS}
    depends_on:
      - <%= APP_NAME %>-mongodb
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker-alerts:
    container_name: <%= APP_NAME %>-worker-alerts
    restart: unless-stopped
    volumes:
      - ./api:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-mongodb:27017", "--", "npm", "run" ,"dev:worker"]
    build:
      context: .
      dockerfile: Dockerfile-worker
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_WORKER_ALERTS}
    depends_on:
      - <%= APP_NAME %>-mongodb
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker-aggregate:
    container_name: <%= APP_NAME %>-worker-aggregate
    restart: unless-stopped
    volumes:
      - ./api:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-mongodb:27017", "--", "npm", "run" ,"dev:worker"]
    build:
      context: .
      dockerfile: Dockerfile-worker
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_WORKER_AGGREGATE}
    depends_on:
      - <%= APP_NAME %>-mongodb
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker-image-metadata:
    container_name: <%= APP_NAME %>-worker-image-metadata
    restart: unless-stopped
    volumes:
      - ./api:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-mongodb:27017", "--", "npm", "run" ,"dev:worker"]
    build:
      context: .
      dockerfile: Dockerfile-worker
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_WORKER_IMAGE_METADATA}
    depends_on:
      - <%= APP_NAME %>-mongodb
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-mongodb:
    container_name: <%= APP_NAME %>-mongodb
    image: ghcr.io/zcube/bitnami-compat/mongodb:6.0.2
    ports:
      - "27017:27017"
    volumes:
      - <%= APP_NAME %>_mongodb_data:/bitnami
    env_file:
      - .env
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-redis:
    container_name: <%= APP_NAME %>-redis
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/redis:7.0.5
    environment:
      REDIS_PASSWORD: ${APP_REDIS_PASSWORD}
    volumes:
      - <%= APP_NAME %>_redis_data:/bitnami
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-redis-sockets:
    container_name: <%= APP_NAME %>-redis-sockets
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/redis:7.0.5-debian-11-r2
    environment:
      REDIS_PASSWORD: ${APP_REDIS_SOCKETS_PASSWORD}
    volumes:
      - <%= APP_NAME %>_redis_sockets_data:/bitnami
    networks:
      - <%= APP_NAME %>

volumes:
  <%= APP_NAME %>_mongodb_data:
  <%= APP_NAME %>_redis_data:
  <%= APP_NAME %>_redis_sockets_data:
  <%= APP_NAME %>_worker_data:

networks:
  <%= APP_NAME %>:
