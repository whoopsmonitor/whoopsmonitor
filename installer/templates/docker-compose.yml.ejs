version: '3'

services:
  <%= APP_NAME %>-api:
    container_name: <%= APP_NAME %>-api
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    ports:
      - "1337:1337"
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/api:<%= DOCKER_IMAGE_VERSION %>
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_API}
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-redis-sockets
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker-checks:
    container_name: <%= APP_NAME %>-worker-checks
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/worker-checks:<%= DOCKER_IMAGE_VERSION %>
    env_file:
      - .env
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker-aggregate:
    container_name: <%= APP_NAME %>-worker-aggregate
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/worker-aggregate:<%= DOCKER_IMAGE_VERSION %>
    env_file:
      - .env
    environment:
      - APP_NAME=${APP_NAME_WORKER_AGGREGATE}
    depends_on:
      - <%= APP_NAME %>-mongodb
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-alerting:
    container_name: <%= APP_NAME %>-alerting
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/alerting:<%= DOCKER_IMAGE_VERSION %>
    env_file:
      - .env
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-image-metadata:
    container_name: <%= APP_NAME %>-image-metadata
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/image-metadata:<%= DOCKER_IMAGE_VERSION %>
    env_file:
      - .env
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-monitor:
    container_name: <%= APP_NAME %>-monitor
    restart: unless-stopped
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/monitor:<%= DOCKER_IMAGE_VERSION %>
    ports:
      - "9000:9000"
    env_file:
      - .env
    environment:
      API_TOKEN: ${APP_TOKEN}
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-mongodb:
    container_name: <%= APP_NAME %>-mongodb
    <!-- image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/mongodb:6.0.2 -->
    image: ghcr.io/zcube/bitnami-compat/mongodb:6.0.2
    ports:
      - "27017:27017"
    volumes:
      - <%= APP_NAME %>_mongodb_data:/bitnami
    env_file:
      - .env
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-redis:
    container_name: <%= APP_NAME %>-redis
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/redis:7.0.5
    environment:
      REDIS_PASSWORD: ${APP_REDIS_PASSWORD}
    volumes:
      - <%= APP_NAME %>_redis_data:/bitnami
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-redis-sockets:
    container_name: <%= APP_NAME %>-redis-sockets
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/redis:7.0.5-debian-11-r2
    environment:
      REDIS_PASSWORD: ${APP_REDIS_SOCKETS_PASSWORD}
    volumes:
      - <%= APP_NAME %>_redis_sockets_data:/bitnami
    networks:
      - <%= APP_NAME %>

volumes:
  <%= APP_NAME %>_mongodb_data:
  <%= APP_NAME %>_redis_data:
  <%= APP_NAME %>_redis_sockets_data:
  <%= APP_NAME %>_worker_data:

networks:
  <%= APP_NAME %>:
