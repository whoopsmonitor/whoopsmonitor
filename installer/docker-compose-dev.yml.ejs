version: '3'

services:
  <%= APP_NAME %>-api:
    container_name: <%= APP_NAME %>-api
    restart: unless-stopped
    ports:
      - "1337:1337"
    volumes:
      - ./api:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-mongodb:27017", "--", "npm", "run" ,"dev"]
    build:
      context: .
      dockerfile: Dockerfile-api
    environment:
      NODE_ENV: development
      CONFIG_CORS_ALLOW_ORIGINS: '*'
      APP_PASSWORD: <%= APP_PASSWORD %>
      MONGO_CONNECTION: mongodb://<%= MONGODB_USERNAME %>:<%= MONGODB_PASSWORD %>@<%= APP_NAME %>-mongodb:27017/<%= MONGODB_DATABASE %>?authSource=<%= APP_NAME %>
      APP_DATA_ENCRYPTION_KEY: <%= APP_DATA_ENCRYPTION_KEY %>
      APP_REDIS_PASSWORD: <%= APP_REDIS_PASSWORD %>
      APP_REDIS_CONNECTION_HOST: <%= APP_NAME %>-redis
      APP_REDIS_CONNECTION_PORT: 6379
      APP_TOKEN: <%= APP_TOKEN %>
      APP_QUEUE_NAME_EXECUTE_CHECK: execute-check
      APP_QUEUE_NAME_ALERTING: alerting
      APP_REDIS_SOCKETS_CONNECTION_HOST: <%= APP_NAME %>-redis-sockets
      APP_REDIS_SOCKETS_CONNECTION_PORT: 6379
      APP_REDIS_SOCKETS_PASSWORD: <%= APP_REDIS_SOCKETS_PASSWORD %>
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-redis-sockets
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-worker:
    container_name: <%= APP_NAME %>-worker
    restart: unless-stopped
    volumes:
      - ./worker:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - <%= APP_NAME %>_worker_data:/<%= APP_NAME %>-worker
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-api:1337", "--", "npm", "run" ,"dev"]
    build:
      context: .
      dockerfile: Dockerfile-worker
    environment:
      NODE_ENV: development
      APP_REDIS_PASSWORD: <%= APP_REDIS_PASSWORD %>
      APP_REDIS_HOST: <%= APP_NAME %>-redis
      APP_REDIS_PORT: 6379
      APP_API_URL: http://<%= APP_NAME %>-api:1337
      APP_QUEUE_NAME_EXECUTE_CHECK: execute-check
      APP_QUEUE_NAME_ALERTING: alerting
      APP_TOKEN: <%= APP_TOKEN %>
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-alerting:
    container_name: <%= APP_NAME %>-alerting
    restart: unless-stopped
    volumes:
      - ./alerting:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-api:1337", "--", "npm", "run" ,"dev"]
    build:
      context: .
      dockerfile: Dockerfile-alerting
    environment:
      NODE_ENV: development
      APP_REDIS_PASSWORD: <%= APP_REDIS_PASSWORD %>
      APP_REDIS_HOST: <%= APP_NAME %>-redis
      APP_REDIS_PORT: 6379
      APP_API_URL: http://<%= APP_NAME %>-api:1337
      APP_QUEUE_NAME_ALERTING: alerting
      APP_TOKEN: <%= APP_TOKEN %>
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-image-metadata:
    container_name: <%= APP_NAME %>-image-metadata
    restart: unless-stopped
    volumes:
      - ./image-metadata:/app
      - /app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock:rw
    command: ["/opt/bin/wait-for-it.sh", "<%= APP_NAME %>-api:1337", "--", "npm", "run" ,"dev"]
    build:
      context: .
      dockerfile: Dockerfile-image-metadata
    environment:
      NODE_ENV: development
      API_URL: http://<%= APP_NAME %>-api:1337
      APP_TOKEN: <%= APP_TOKEN %>
    depends_on:
      - <%= APP_NAME %>-mongodb
      - <%= APP_NAME %>-redis
      - <%= APP_NAME %>-api
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-mongodb:
    container_name: <%= APP_NAME %>-mongodb
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/mongodb:6.0.2-debian-11-r3
    ports:
      - "27017:27017"
    volumes:
      - <%= APP_NAME %>_mongodb_data:/bitnami
    environment:
      MONGODB_ROOT_PASSWORD: <%= MONGODB_ROOT_PASSWORD %>
      MONGODB_DATABASE: <%= MONGODB_DATABASE %>
      MONGODB_USERNAME: <%= MONGODB_USERNAME %>
      MONGODB_PASSWORD: <%= MONGODB_PASSWORD %>
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-redis:
    container_name: <%= APP_NAME %>-redis
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/redis:7.0.5-debian-11-r2
    environment:
      REDIS_PASSWORD: <%= APP_REDIS_PASSWORD %>
    volumes:
      - <%= APP_NAME %>_redis_data:/bitnami
    networks:
      - <%= APP_NAME %>

  <%= APP_NAME %>-redis-sockets:
    container_name: <%= APP_NAME %>-redis-sockets
    image: ghcr.io/<%= APP_NAME %>/<%= APP_NAME %>/bitnami/redis:7.0.5-debian-11-r2
    environment:
      REDIS_PASSWORD: <%= APP_REDIS_SOCKETS_PASSWORD %>
    volumes:
      - <%= APP_NAME %>_redis_sockets_data:/bitnami
    networks:
      - <%= APP_NAME %>

volumes:
  <%= APP_NAME %>_mongodb_data:
  <%= APP_NAME %>_redis_data:
  <%= APP_NAME %>_redis_sockets_data:
  <%= APP_NAME %>_worker_data:

networks:
  <%= APP_NAME %>:
